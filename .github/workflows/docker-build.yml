name: Docker image build (parallel arch)

on:
  push:
    branches: [ "master" ]
    paths:
      - ".github/workflows/docker-build.yml"
      - "Dockerfile.php.*"

permissions:
  contents: read
  packages: write

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository_owner }}/docker-php-fpm

jobs:
  build:
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        arch: [ amd64, arm64 ]
        image:
          - { name: "php8.1", file: "./Dockerfile.php.8.1" }
          - { name: "php8.2", file: "./Dockerfile.php.8.2" }
          - { name: "php8.3", file: "./Dockerfile.php.8.3" }
          - { name: "php8.4", file: "./Dockerfile.php.8.4" }
          - { name: "php8.5", file: "./Dockerfile.php.8.5" }
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up QEMU
        if: matrix.arch == 'arm64' && runner.arch != 'ARM64'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push single-arch image (linux/${{ matrix.arch }}, ${{ matrix.image.name }})
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          file: ${{ matrix.image.file }}
          platforms: linux/${{ matrix.arch }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}
          provenance: false
          sbom: false
          cache-from: type=gha,scope=${{ github.workflow }}-${{ matrix.image.name }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ matrix.image.name }}-${{ matrix.arch }}

      - name: Export digest artifact
        run: |
          mkdir -p /tmp/digests
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}-${{ matrix.arch }}@${{ steps.build.outputs.digest }}" \
            > "/tmp/digests/${{ matrix.image.name }}-${{ matrix.arch }}.txt"
        shell: bash

      - name: Upload digest
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: digests-${{ matrix.image.name }}-${{ matrix.arch }}
          path: /tmp/digests/*.txt
          if-no-files-found: error

  merge:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        image:
          - { name: "php8.1" }
          - { name: "php8.2" }
          - { name: "php8.3" }
          - { name: "php8.4" }
          - { name: "php8.5" }
    steps:
      - name: Download digests for ${{ matrix.image.name }}
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          pattern: digests-${{ matrix.image.name }}-*
          merge-multiple: true
          path: /tmp/digests

      - name: Set up Buildx (for imagetools)
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          # Create a consolidated multi-arch tag without the per-arch suffix
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}"
          REFS=$(cat /tmp/digests/*.txt | tr '\n' ' ')
          echo "Creating manifest ${IMAGE} from:"
          echo "${REFS}"
          docker buildx imagetools create -t "${IMAGE}" ${REFS}
        shell: bash
