name: Docker image build (parallel arch)

on:
  push:
    branches: [ "master" ]
    paths:
      - ".github/workflows/docker-build.yml"
      - "Dockerfile.php.*"

permissions:
  contents: read
  packages: write

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository_owner }}/docker-php-fpm

jobs:
  build:
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        arch: [ amd64, arm64 ]
        image:
          - { name: "php8.1", file: "./Dockerfile.php.8.1" }
          - { name: "php8.2", file: "./Dockerfile.php.8.2" }
          - { name: "php8.3", file: "./Dockerfile.php.8.3" }
          - { name: "php8.4", file: "./Dockerfile.php.8.4" }
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Set up QEMU
        if: matrix.arch == 'arm64' && runner.arch != 'ARM64'
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push single-arch image (linux/${{ matrix.arch }}, ${{ matrix.image.name }})
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          file: ${{ matrix.image.file }}
          platforms: linux/${{ matrix.arch }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}
          provenance: false
          sbom: false
          cache-from: type=gha,scope=${{ github.workflow }}-${{ matrix.image.name }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ github.workflow }}-${{ matrix.image.name }}-${{ matrix.arch }}

      - name: Export digest artifact
        run: |
          mkdir -p /tmp/digests
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}-${{ matrix.arch }}@${{ steps.build.outputs.digest }}" \
            > "/tmp/digests/${{ matrix.image.name }}-${{ matrix.arch }}.txt"
        shell: bash

      - name: Upload digest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: digests-${{ matrix.image.name }}-${{ matrix.arch }}
          path: /tmp/digests/*.txt
          if-no-files-found: error

  merge:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        image:
          - { name: "php8.1" }
          - { name: "php8.2" }
          - { name: "php8.3" }
          - { name: "php8.4" }
    steps:
      - name: Download digests for ${{ matrix.image.name }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          pattern: digests-${{ matrix.image.name }}-*
          merge-multiple: true
          path: /tmp/digests

      - name: Set up Buildx (for imagetools)
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          # Create a consolidated multi-arch tag without the per-arch suffix
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:latest-${{ matrix.image.name }}"
          REFS=$(cat /tmp/digests/*.txt | tr '\n' ' ')
          echo "Creating manifest ${IMAGE} from:"
          echo "${REFS}"
          docker buildx imagetools create -t "${IMAGE}" ${REFS}
        shell: bash
